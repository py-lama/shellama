# Makefile dla projektu Spylog z Poetry

.PHONY: help install install-dev test test-cov clean build publish publish-test lint format check docs dev-setup

# DomyÅ›lny cel
help:
	@echo "ðŸ” Spylog - Python Validator Proxy"
	@echo "=================================="
	@echo ""
	@echo "DostÄ™pne komendy Poetry:"
	@echo "  install      - poetry install"
	@echo "  install-dev  - poetry install z dev dependencies"
	@echo "  shell        - poetry shell (aktywuj Å›rodowisko)"
	@echo "  test         - poetry run pytest"
	@echo "  test-cov     - poetry run pytest z pokryciem"
	@echo "  lint         - flake8 + mypy"
	@echo "  format       - black"
	@echo "  check        - format + lint + test"
	@echo "  clean        - wyczyÅ›Ä‡ pliki tymczasowe"
	@echo "  build        - poetry build"
	@echo "  publish-test - poetry publish do TestPyPI"
	@echo "  publish      - poetry publish do PyPI"
	@echo "  dev-setup    - kompletna konfiguracja deweloperska"
	@echo ""
	@echo "Pomocnicze:"
	@echo "  info         - informacje o projekcie"
	@echo "  deps         - pokaÅ¼ drzewo zaleÅ¼noÅ›ci"
	@echo "  update       - poetry update"

# SprawdÅº czy Poetry jest dostÄ™pne
check-poetry:
	@which poetry > /dev/null || (echo "âŒ Poetry nie jest zainstalowane. Zainstaluj z: https://python-poetry.org/docs/#installation" && exit 1)

# Instalacja
install: check-poetry
	@echo "ðŸ“¦ Instalowanie Spylog..."
	poetry install --only main

install-dev: check-poetry
	@echo "ðŸ”§ Instalowanie w trybie deweloperskim..."
	poetry install

# Aktywacja Å›rodowiska
shell: check-poetry
	@echo "ðŸš Aktywacja Å›rodowiska Poetry..."
	poetry shell

# Testy
test: check-poetry
	@echo "ðŸ§ª Uruchamianie testÃ³w..."
	poetry run pytest tests/ -v

test-cov: check-poetry
	@echo "ðŸ§ª Uruchamianie testÃ³w z pokryciem kodu..."
	poetry run pytest tests/ -v --cov=spylog --cov-report=html --cov-report=term-missing

# JakoÅ›Ä‡ kodu
lint: check-poetry
	@echo "ðŸ” Sprawdzanie jakoÅ›ci kodu..."
	@echo "â†’ flake8..."
	poetry run flake8 spylog tests
	@echo "â†’ mypy..."
	poetry run mypy spylog

format: check-poetry
	@echo "âœ¨ Formatowanie kodu..."
	poetry run black spylog tests

check: format lint test
	@echo "âœ… Wszystkie sprawdzenia zakoÅ„czone pomyÅ›lnie!"

# Czyszczenie
clean:
	@echo "ðŸ§¹ Czyszczenie plikÃ³w tymczasowych..."
	rm -rf build/
	rm -rf dist/
	rm -rf *.egg-info/
	rm -rf htmlcov/
	rm -rf .pytest_cache/
	rm -rf .mypy_cache/
	rm -rf .coverage
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete

# Budowanie i publikacja
build: check-poetry clean
	@echo "ðŸ—ï¸  Budowanie paczki..."
	poetry build

publish-test: check-poetry build
	@echo "ðŸ“¤ Publikacja na TestPyPI..."
	poetry config repositories.testpypi https://test.pypi.org/legacy/
	poetry publish -r testpypi

publish: check-poetry build
	@echo "ðŸ“¤ Publikacja na PyPI..."
	poetry publish

# ZarzÄ…dzanie zaleÅ¼noÅ›ciami
deps: check-poetry
	@echo "ðŸ“Š Drzewo zaleÅ¼noÅ›ci:"
	poetry show --tree

update: check-poetry
	@echo "ðŸ”„ Aktualizacja zaleÅ¼noÅ›ci..."
	poetry update

# Dodawanie zaleÅ¼noÅ›ci
add-dep: check-poetry
	@echo "âž• Dodaj zaleÅ¼noÅ›Ä‡ (uÅ¼yj: make add-dep DEP=nazwa-paczki)"
	poetry add $(DEP)

add-dev-dep: check-poetry
	@echo "âž• Dodaj zaleÅ¼noÅ›Ä‡ deweloperskÄ…"
	poetry add --group dev $(DEP)

# Konfiguracja deweloperska
dev-setup: check-poetry
	@echo "ðŸš€ Konfiguracja Å›rodowiska deweloperskiego..."
	poetry install
	poetry run pre-commit install 2>/dev/null || echo "âš ï¸  pre-commit nie jest zainstalowane"
	@echo ""
	@echo "âœ… Åšrodowisko deweloperskie gotowe!"
	@echo ""
	@echo "NastÄ™pne kroki:"
	@echo "1. poetry shell       # Aktywuj Å›rodowisko"
	@echo "2. make test          # Uruchom testy"
	@echo "3. make format        # Sformatuj kod"
	@echo "4. make check         # SprawdÅº wszystko"

# Pre-commit hook
pre-commit: format lint test
	@echo "âœ… Pre-commit sprawdzenia zakoÅ„czone!"

# Uruchamianie Spylog
run: check-poetry
	@echo "ðŸš€ Uruchamianie Spylog..."
	poetry run spylog $(ARGS)

# Informacje o projekcie
info: check-poetry
	@echo "ðŸ“Š Informacje o projekcie Spylog"
	@echo "================================"
	@echo "Wersja Poetry: $(shell poetry --version 2>/dev/null || echo 'Nie zainstalowane')"
	@echo "Wersja Python: $(shell poetry run python --version 2>/dev/null || echo 'Åšrodowisko nieaktywne')"
	@echo "Lokalizacja Å›rodowiska: $(shell poetry env info --path 2>/dev/null || echo 'Brak')"
	@echo "Wersja Spylog: $(shell poetry run python -c "import spylog; print(spylog.__version__)" 2>/dev/null || echo 'Nie zainstalowane')"
	@echo ""
	@echo "Status projektu:"
	@find . -name "*.py" -not -path "./build/*" -not -path "./dist/*" -not -path "./.venv/*" | wc -l | sed 's/^/Pliki Python: /'
	@find . -name "*.py" -not -path "./build/*" -not -path "./dist/*" -not -path "./.venv/*" | xargs wc -l | tail -1 | sed 's/^/ÅÄ…czne linie: /'

# Åšrodowisko wirtualne
venv-info: check-poetry
	@echo "ðŸ” Informacje o Å›rodowisku wirtualnym:"
	poetry env info

venv-remove: check-poetry
	@echo "ðŸ—‘ï¸  Usuwanie Å›rodowiska wirtualnego..."
	poetry env remove --all

# BezpieczeÅ„stwo
security-check: check-poetry
	@echo "ðŸ”’ Sprawdzanie bezpieczeÅ„stwa zaleÅ¼noÅ›ci..."
	poetry run pip list --format=freeze | poetry run safety check --stdin || echo "âš ï¸  safety nie jest zainstalowane"

# Dokumentacja
docs:
	@echo "ðŸ“š Generowanie dokumentacji..."
	@echo "README.md jest gÅ‚Ã³wnÄ… dokumentacjÄ…"
	@echo "Dodatkowa dokumentacja moÅ¼e byÄ‡ dodana w przyszÅ‚oÅ›ci"

# Instalacja z aliasem
install-with-alias: install-dev
	@echo "ðŸ”— Uruchamianie skryptu instalacyjnego z aliasem..."
	@bash install.sh

# Testowanie pakietu
test-package: build
	@echo "ðŸ§ª Testowanie zbudowanej paczki..."
	poetry run pip install dist/*.whl --force-reinstall
	poetry run spylog --help

# Sprawdzenie Å›rodowiska
env-check: check-poetry
	@echo "ðŸ” Sprawdzanie Å›rodowiska..."
	@echo "Poetry: $(shell poetry --version)"
	@echo "Python w Poetry: $(shell poetry run python --version 2>/dev/null || echo 'Åšrodowisko nieaktywne')"
	@echo "Pip w Poetry: $(shell poetry run pip --version 2>/dev/null || echo 'Åšrodowisko nieaktywne')"
	@echo "Lokalizacja Poetry env: $(shell poetry env info --path 2>/dev/null || echo 'Brak')"

# Linting z rÃ³Å¼nymi narzÄ™dziami
lint-all: check-poetry
	@echo "ðŸ” Kompleksowe sprawdzanie kodu..."
	@echo "â†’ black --check..."
	poetry run black --check spylog tests || echo "âŒ Kod wymaga formatowania"
	@echo "â†’ flake8..."
	poetry run flake8 spylog tests
	@echo "â†’ mypy..."
	poetry run mypy spylog
	@echo "â†’ pytest..."
	poetry run pytest tests/ --tb=short

# Aktualizacja wersji
bump-version:
	@echo "ðŸ“ˆ Aktualizacja wersji..."
	@echo "Obecna wersja: $(shell poetry version -s)"
	poetry version patch
	@echo "Nowa wersja: $(shell poetry version -s)"
	@echo "ðŸ’¡ Nie zapomnij zaktualizowaÄ‡ __init__.py!"

# CI/CD helpers
ci-install: check-poetry
	@echo "ðŸ”„ Instalacja dla CI/CD..."
	poetry install --no-interaction --no-ansi

ci-test: check-poetry
	@echo "ðŸ¤– Testy dla CI/CD..."
	poetry run pytest tests/ --tb=short --no-header -q

ci-build: check-poetry
	@echo "ðŸ—ï¸  Budowanie dla CI/CD..."
	poetry build --no-interaction --no-ansi

# Debugowanie
debug: check-poetry
	@echo "ðŸ› Tryb debugowania..."
	@echo "Zmienne Å›rodowiskowe:"
	@env | grep -E "(PYTHON|POETRY|SPYLOG)" || echo "Brak zmiennych PYTHON/POETRY/SPYLOG"
	@echo ""
	@echo "ZawartoÅ›Ä‡ dist/:"
	@ls -la dist/ 2>/dev/null || echo "Katalog dist/ nie istnieje"
	@echo ""
	@echo "Status git:"
	@git status --porcelain 2>/dev/null || echo "Nie jest repozytorium git"

# Kompletny reset
reset: clean venv-remove
	@echo "ðŸ”„ Kompletny reset projektu..."
	rm -rf poetry.lock
	@echo "âœ… Reset zakoÅ„czony. Uruchom 'make install-dev' aby reinstalowaÄ‡"

# Quick start dla nowych deweloperÃ³w
quickstart: check-poetry
	@echo "ðŸš€ Quick start dla Spylog"
	@echo "========================"
	@echo ""
	@echo "1. Instalacja Å›rodowiska:"
	@echo "   make install-dev"
	@echo ""
	@echo "2. Aktywacja Å›rodowiska:"
	@echo "   poetry shell"
	@echo ""
	@echo "3. Uruchomienie testÃ³w:"
	@echo "   make test"
	@echo ""
	@echo "4. Formatowanie kodu:"
	@echo "   make format"
	@echo ""
	@echo "5. Kompleksowe sprawdzenie:"
	@echo "   make check"
	@echo ""
	@echo "6. Budowanie paczki:"
	@echo "   make build"